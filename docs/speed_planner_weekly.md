# 生徒スピードプランナー「週間管理」仕様

> **Note (2026-01-09)**: このドキュメントは元々GAS WebApp経由のアーキテクチャ用に作成されましたが、現在はMCPサーバーがGoogle Sheets APIを直接呼び出す構成に移行しています。シートのレイアウト仕様は引き続き有効です。

この文書は、各生徒シートの「週間管理」（Speed Planner）を安全に読み書きするための仕様メモです。

## 目的
- MCPサーバー（Railway）がGoogle Sheets APIを直接呼び出し、LLM用に二段階書き込み（preview → confirm）等のガードを実装。
- 既存の参考書マスター／生徒マスターと整合させ、LLMからも扱いやすいJSON I/Oを定義。
- 人手運用の自由度（自然言語の計画記述）を尊重しつつ、可能な範囲で正規化と検証を行う。

## 対象スプレッドシートと検証用 CSV
- 対象: 生徒ごとのスプレッドシートの「週間管理」シート（正式）。
  - 互換: 一部シート名が「週間計画」となっている場合も自動検出。
- 検証用 CSV: 例「酒井なつめ_新3年_14.xlsm - 週間管理.csv」。これは「週間計画」シートのエクスポート（displayValue 相当）。
  - 仕様上の優先はスプレッドシート本体。CSV は検証・回帰テスト用の固定フィクスチャとして活用。

## レイアウト（確定事項＋補足）
- データ行範囲: 4 行目〜30 行目が実データ領域。
- A 列（A4:A30）: 「<月コード><book_id>」の displayValue（他シートから関数参照）。
  - 例: `258gET007`。月コード 258 は 2025 年 8 月（後述）。
  - 参考書マスターと同期している場合: `<book_id>` は必ず `g` で始まる（= gID）。
  - 同期していない場合（過去問・学校課題等）: `<book_id>` は `g` で始まらないことがある（= 非 gID）。
- 週別の計画セル（「目標/実績」= 計画セル）: 各週ごとに 4〜30 行で配置。
  - 週1 計画: H4:H30（左隣=G:目安処理量、さらに左=F:単位処理量、さらに左=E:週間時間）
  - 週2 計画: P4:P30（O:目安、N:単位、M:時間）
  - 週3 計画: X4:X30（W:目安、V:単位、U:時間）
  - 週4 計画: AF4:AF30（AE:目安、AD:単位、AC:時間）
  - 週5 計画: AN4:AN30（AM:目安、AL:単位、AK:時間）
- 週開始日セル: D1=週1の開始日（その月の最初の面談日）、以降は +7 日ずつで L1, T1, AB1, AJ1。
- 目安処理量: スプレッドシート関数で G=E×F（各週の列束でも同様）。小数になりうる（丸め・表示桁はシート準拠）。

### A列の実例（提供サンプル）
```
258gET007
258gET008
258gET002
258gEB001
258gEB003
258gEK001
258gEK002
258gEC009
25814EC11
25814EC01
25814EC14
25831MB011
25831MB012
258gMB081
258gCH007
258gCH008
```
- `g` 直後が gID の例（同期済み）と、`g` が無い例（非同期タスク）が混在。
- 取り出し規則: `^(?<month>(?:\d{3}|\d{4}))(?<item>.+)$` で分離。`item` が `^g` なら gID、それ以外は非gID。
- 空行: A 列が空の行は他列も空。データは上から詰めて入力されるため、最初の空行で走査終了。

## 計画テキスト（自然言語）
- 基本は「〜」（全角チルダ）などで範囲を表現（例: 「第3章1節〜第3章4節」「p.12〜p.34」「演習1〜10」）。
- 範囲以外の自由記述もある（例: 「復習のみ」「口頭で指示」「休み」「模試対策」など）。
- 原則として人間可読な自由度を維持。機械可読への正規化は「可能な場合のみ」行い、困難な場合は原文を保持して warning を添付。
- Reference Book の採番ルール準拠（章→節→番号）。クロスチャプター開始ポリシーは「デフォルト reset、明示時のみ carry（またぐ）」を原則とする。

## 月コード仕様（更新）
- 例: 258 = 2025 年 8 月、2510 = 2025 年 10 月。
- 年境界で現行システムに揺れがある: 2026 年 1 月は `261` または `2601` の両方が存在しうる。
- 取り扱い方針: いずれの表記にもマッチし、同一の 2026-01 として正規化（パース）できるようにする。
- 週間計画シートは「単一月」専用であり、同一シート内に複数の月コードが混在することはない前提。

## 読み取り API（案）
### planner_get（読み取り・metrics統合）
- 入力: `student_id`（必須）。`month_code` は省略可（単一月前提のため A 列から自動判定）。
- 動作: A4:A30 の displayValue から `<月コード>` と `<book_id>` を切り出し、4〜30 行を対象に各週（1〜5）の計画テキストを収集。D1, L1, T1, AB1, AJ1 も取得。MCP 側で metrics（E/F/G）を週×行に統合して返す。
- 返却（例）:
```json
{
  "student_id": "S123",
  "month_code": 258,
  "weeks": [
    {
      "index": 1,
      "start_date": "2025-08-04",
      "column": "H",
      "rows": [
        {
          "row": 4,
          "raw_code": "258gET007",  // displayValue（A4）
          "month_code": 258,
          "book_id": "gET007",      // `g` で始まらない場合もあり得る
          "plan_text": "第3章1節〜第3章4節",
          "weekly_minutes": 180,
          "unit_load": 0.0667,
          "guideline_amount": 12.0,
          "parsed": {
            "type": "range",
            "from": {"chapter": 3, "section": 1},
            "to":   {"chapter": 3, "section": 4}
          },
          "warnings": []
        }
      ]
    }
  ]
}
```

### planner_weeks
- 入力: `student_id`, `month_code`。
- 返却: 各週の開始日（D1, L1, T1, AB1, AJ1 の displayValue を ISO 日付へ正規化）、週数、列情報。

## 書き込み API（案・二段階）
### planner_propose（プレビュー：MCP 側で実装）
- 入力:
```json
{
  "student_id": "S123",
  "month_code": 258,
  "week_index": 2,
  "items": [
    {
      "book_id": "gET007",   // 非gIDの可能性もある
      "plan_text": "p.40〜p.72",
      "override_amount": null,
      "mode": "plan_only"  // plan_only | append_actual | replace_all（後述）
    }
  ]
}
```
- 振る舞い:
  - セル解決（行特定、対象列特定）。
  - 目安処理量の再計算（週間時間×単位処理量）。`override_amount` があれば差分表示。
  - 正規化可能な計画は `parsed` を付与。不明瞭な場合は `warnings`。
  - 「目標/実績」は単一文字列として扱う。既定は「空欄を優先的に埋める」。上書きは明示指示がある場合のみ（`overwrite=true`）。
- 出力（例）:
```json
{
  "token": "opaque-preview-token",
  "effects": [
    {
      "cell": "P7",
      "before": {"plan_text": "", "guideline_amount": 10},
      "after":  {"plan_text": "p.40〜p.72", "guideline_amount": 10}
    }
  ],
  "warnings": []
}
```

### planner_confirm（確定）
- 入力: `token`。
- 振る舞い: プレビュー確定、同時編集検出（最終取得時刻／ETag 的な整合チェック）。
- 出力: 書き込み結果、失敗時は衝突情報を返す。

## セルマッピング（確定）
- 週1: `E=週間時間`, `F=単位処理量`, `G=目安処理量(E×F)`, `H=目標/実績(計画)`。
- 週2: `M=週間時間`, `N=単位処理量`, `O=目安処理量`, `P=目標/実績`。
- 週3: `U=週間時間`, `V=単位処理量`, `W=目安処理量`, `X=目標/実績`。
- 週4: `AC=週間時間`, `AD=単位処理量`, `AE=目安処理量`, `AF=目標/実績`。
- 週5: `AK=週間時間`, `AL=単位処理量`, `AM=目安処理量`, `AN=目標/実績`。
- データ行は 4〜30 のみを対象。

## 計算と丸め
- 目安処理量 = 週間時間 × 単位処理量。
- 小数の丸め規則（四捨五入／切り上げ／切り捨て／表示は少数何桁）は要確認。
- 単位（ページ／項目数／ユニットなど）は参考書ごとに異なる可能性があるため、Books 側のメタデータと連携（要検討）。

## 週開始日の取り扱い
- D1 が当該月の「最初の面談日」。以降は +7 日で L1, T1, AB1, AJ1。
- 表示値を ISO 日付へ解釈。タイムゾーンは JST 前提。
- 祝日・連休等による例外運用は現時点では考慮しない（必要になれば拡張）。

## GAS API（最小権限セット）
- 読み取り（GET）
  - `planner_ids_list`: A4:D30 を返す。
    - A列: `raw_code` を `month_code` + `book_id` へ分離
    - B列: `subject`（教科）
    - C列: `title`（参考書タイトル。非gID時に重要）
    - D列: `guideline_note`（進め方の目安・参考）
  - `planner_dates_get`: D1, L1, T1, AB1, AJ1 の displayValue を返す。
  - `planner_metrics_get`: 週別の E/F/G（週間時間/単位処理量/目安処理量）を週1〜週5分、行4〜30について返す。
  - `planner_plan_get`: 週別の計画セル（H/P/X/AF/AN）の文字列を返す（改行保持）。
- 書き込み（POST/PUT）
  - `planner_dates_set`: D1 のみ書き込み可（入力: ISO `YYYY-MM-DD`。L1/T1/AB1/AJ1 は+7表示のみ、読み取り専用）。
  - `planner_plan_set`: 指定週×行 または 週×`book_id` で計画セルに書き込み。
    - 前提条件（必須）:
      - A列が空でない（課題が存在）。
      - 対象週の「週間時間」セルが空でない（その週に実行する課題）。
    - 既定: 空欄のみ書き込み（`overwrite=false`）。
    - 明示: 上書きを許可（`overwrite=true`）。
    - 文字数上限: 最大 52 文字（下記参照）。超過時はエラーで拒否。
    - 改行を含む任意文字列を許容。セル全体置換のみ（差分編集は行わない）。
- 非対応（書き込み禁止）
  - A 列の編集（ID/コード）、E/F/G（週間時間/単位処理量/目安処理量）、L1/T1/AB1/AJ1 の直接書き込み。

## MCP 側の責務（参考）
- GAS の最小 API を組み合わせ、LLM からの操作に対して propose/confirm の二段階制御、衝突検出、入力バリデーション、計画生成ガイド適用を行う。

### MCP ツール案（GASラップ）
- `planner_get`: GASの4種GETをまとめて1レスポンスへ集約。
- `planner_plan_propose`: 書込み対象の解決・検証・差分作成（`overwrite`方針の確認）。
- `planner_plan_confirm`: propose トークンを確定して GAS の `planner_plan_set` を実行。
- `planner_dates_propose`/`planner_dates_confirm`: D1 変更のプレビューと確定。

### 書き込みバリデーション（MCP 推奨）
- 前提条件（A列非空/週間時間非空）の検証と、既存文字列の有無に応じた `overwrite` の制御。
- 文字数上限の事前チェック（GAS ではエラー、MCP では propose 段階で警告→confirm でブロック）。

## 検証・バリデーション（例）
- 月コード不正、週 index 不正（1〜5 以外）、行範囲外（4〜30 以外）。
- A 列の displayValue が空／参照切れ。
- 1 冊が複数行（親子行）に分かれるケースの扱い（Books の親子行ルールと整合）。
- 計画テキストがパース不能／曖昧な場合は原文保持＋警告。

## 計画文字列の上限
- 現在の最長想定例: 「ワーク(Reading)+ 丁寧に音読 ※ゆっくり再生して、同じ音で発音する練習」
- 上限: 上記の約 1.3 倍 = 52 文字（Unicode コードポイント基準、改行含む）。
- 超過時の扱い:
  - GAS: `planner_plan_set` は 400 番台エラーで拒否し、要約/短縮を促すメッセージを返す。
  - MCP: propose 段階で警告を出し、confirm をブロック（短縮指示へ誘導）。

## 権限・安全性
- GAS: 読み取り GET、書き込みは propose（POST）→ confirm（POST）。
- シート名固定、対象範囲を限定、変更差分を返す。監査ログ（student_id、操作者、時刻、diff）を推奨。

## テスト方針
- GAS dev テスト: CSV フィクスチャでレイアウトの回帰担保、displayValue と整合検証。
- MCP E2E: planner_get → planner_propose → planner_confirm の流れ。書き込みはプレビュー中心で、安全確認後に限定的に実施。

## 未確定点・要質問（深掘り版）
1) A列 displayValue の厳密形式:
   - 文字列は単純連結（例 `258gET007`）で確定理解。非 gID 例も1つ提示いただけますか（例: `258XX-SCHOOL-2024` など）。
2) 単一月前提の確認:
   - 常に単一月と理解。もし A4:A30 が空行混在や一部欠損のときの扱い（無視/エラー）を決めたいです。
3) 「目標/実績」セルの運用:（更新済み）
   - 既定は空欄優先で埋める。上書きは明示の指示がある場合のみ。
4) 書き込み対象の限定:
   - LLM が編集して良いのは計画セル（H,P,X,AF,AN）のみでよいですか？E/F は人手のみ、G は数式のみと理解して保護扱いにします。
5) 行の一意決定キー:
   - gID は一意とのこと。非 gID の場合も `book_id` は行内一意と見なして良いですか？万一重複した場合は「行番号指定」での書き込みを許容します。
6) 計画テキストの多行:
   - 1セル内で改行（CSV ではクォート内改行）を使う運用はありますか？ある場合、`planner_get` は `\n` を保持、`propose/confirm` も保持・追記に対応します。
7) 非 gID タスク:
   - マスター未同期のタスク（過去問・学校課題等）は、そのまま `book_id` として保持・返却で問題ないですか。将来、gID に昇格した場合のレコード突き合わせ方針はありますか？
8) 正規化の粒度:
   - 可能なときは `parsed` に `type=range|list|free` などで構造化します。どの程度までを「パース成功」とみなせば運用に有益ですか？（例: `No.951~1050`、`数A：9~21,29~46` などは list-of-ranges として返却）
9) 既定月:
   - 取得は A 列から一意に決まる前提。もし A4 が空で A5 に値、などの穴あき時は最初の非空を月決定ソースにして良いですか？
10) CSV フィクスチャ仕様（テスト用）:
   - 文字コード: UTF-8 で問題ないですか？改行は `\r\n`/`\n` いずれも受理でよいですか？
   - 小数・カンマ・コロン・全角の取り扱い方針（そのまま保持）で問題ないですか？
11) 親子行について（概念整理）:
   - Planner では 1 `book_id` = 1 行で運用する想定。もし例外（同じ `gID` を同月に2行以上使う）があれば教えてください。なければ親子概念は Planner では不要とします。
12) 週数:
   - 5 週を超えることはない、4 週までで終わる月が多い、とのこと。空セルはそのまま扱い、ゼロ上書き等は行わない理解で良いですか？

## 補足: サンプル文字列への対応方針（読み取りの例）
- `No.951~1050` → `{type: "range", axis: "No.", from: 951, to: 1050}`（best-effort）
- `"No.1601-1700\n(No.101-200 テストだけ)"` → `[{range 1601-1700}, {note: "No.101-200 テストだけ"}]` のように配列化（セル内改行を分割）
- `数A：9~21,29~46　数Ⅱ：114~138` → `[{axis:"数A", ranges:[9-21,29-46]}, {axis:"数Ⅱ", ranges:[114-138]}]`
- 曖昧・自由記述（例: `ワーク`, `Chapter1の復習`）は `{type:"free", text:原文}`。
- 解析不能な場合でも `plan_text` は必ず原文保持し、`warnings` に理由を添付。

---

以上は実装前提の仕様草案です。未確定点の回答を反映して確定版に更新します。
13) D1 の書き込みフォーマット:
   - ISO 形式（例: `2025-08-04`）で受け取り、シート側の表示形式に従う書式で setValue 予定。Excel/シリアル値での入力が必要な場合は指示をください。
14) シート参照方法:
   - `student_id → 生徒のスプレッドシートID → シート名「週間計画」` の解決は Students Master 側に列を追加して参照で良いですか？既存列に格納済みなら列名を教えてください。
